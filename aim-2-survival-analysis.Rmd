---
title: "Aim-2 survival analysis"
author: "Bo"
date: "2024-04-06"
output:
  pdf_document: default
  html_document: default
  word_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=F, message=F, warning=F}
library(ggplot2)
library(dplyr)
library(haven)
library(tidyr)
library(readr)
library(stringr)
library(readxl)
library(gt)
library(kableExtra)
library(survival)
library(glmnet)
library(boot)
library(survminer)
library(knitr)
```

```{r }
scd_data_yr3_label <- readRDS("processed_scd_data.rds")
# naming_vec <- readRDS("var_labels.RDS")
df_lst <- readRDS("categorized_dfsubset.RDS")
getwd()
source("R/survival.R")
events <- c('DEAD', 'GF', 'EFS', 'ANC', 'PLATELET', 'AGVHD', 'CGVHD', 'SCDMAL_FINAL')
features <- c('RCMVPR', 'SEX', 'ETHNICIT', 'DONORF', 'GRAFTYPE', 'YEARTX', 'AGE', 'AGEGPFF', 'KPS', 'HCTCIGPF', 'SUBDIS1F', 'ATGF', 'YEARGPF', 'GVHD_FINAL', 'CONDGRPF', 'CONDGRP_FINAL', 'HLA_FINAL', 'FLAG_LANCET', 'FLAG_BLOOD')
```


```{r}
for(event in events){
  coeff_table <- cox_func(event, scd_data_yr3_label)
  kable_table <- kable(coeff_table, caption = paste("Coefficients of features for", event)) %>% kable_classic(full_width = F, html_font = "Cambria")
  print(kable_table)
  gt::gtsave(gt(coeff_table),  file.path("tables", 
                                paste0("Coefficients of features for", event, ".png")))}
```


```{r}
summarytbl<-summary_table(events, scd_data_yr3_label)
kable_table <- kable(summarytbl, caption = paste("Selected features for different events")) %>% kable_classic(full_width = F, html_font = "Cambria")
print(kable_table)

```

```{r}
expanded_df <- summary_table_wide(events, scd_data_yr3_label)
kable_table <- kable(expanded_df, caption = paste("Selected features for different events")) %>% kable_classic(full_width = F, html_font = "Cambria")
print(kable_table)
gt::gtsave(gt(expanded_df),  file.path("tables", 
                                paste0("Summary table for selected features.png")))
```



```{r,fig.width=12, fig.height=15 }
#for(event in events){
event = 'DEAD'
for(feature in features){
  plot_km(event, feature, scd_data_yr3_label)
  
  }
#}

```